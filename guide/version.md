# 版本控制

该功能目前内测中，暂未开放。

## 简介

版本控制是US3针对用户存储空间（Bucket）提供的一种容灾保护功能，保护用户不会因为错误的覆盖、删除操作，造成数据丢失。

## 版本控制状态
US3版本控制只有有关闭、打开和暂停三种不同的状态。
- 关闭：此状态为Bucket默认的版本控制态，此状态下未开启版本控制。
- 开启：此状态下打开了Bucket的版本控制，用户每次新上传US3的Object将生成一个版本ID，用户上传相同object将不会覆盖前一次的数据。开启状态下，其他object操作见使用说明。
- 暂停：此状态下暂停了Bucket的版本控制，用户每次新上传US33的Object将生成字符串为“null”的版本ID。暂停状态下，其他object操作见使用说明。

需要注意的是
1. 版本控制打开之后将不能再被关闭，只允许暂停。
2. 打开版本控制后，若之前Bucket存在Object，那么这些Object将自动变为null版本。另外，每次对相同Object上传的数据都会被保存下来，此时需要注意相同Object的版本数量，避免出现过多无用版本；
3. 暂停版本控制后，每次新上传相同Object上传的数据将会以唯一的null版本存储，此时存在数据覆盖风险，建议了解后使用。另外，之前打开状态下生成的版本数据若不删除，将会继续存在于该object的版本中。

## 计费
打开过版本控制的Bucket，将按照Bucket内所有Object及其版本所占据的存储空间收取费用。

## 使用说明
### 开启版本控制
用户可以在存储空间>基础设置>版本控制选项中，打开版本控制。
![](/images/guide/多版本_12.png)
开启版本控制后，用户可以在文件管理界面右上角选择是否展示历史版本。选择后，界面将展示文件的所有版本。
![](/images/guide/多版本_13.png)
可以看到，开启版本控制后文件的重复上传将以历史版本的形式保存下来。
![](/images/guide/多版本_14.png)

### 暂停版本控制
用户可以通过存储空间>基础设置>版本控制>暂停选项，暂停版本控制。
![](/images/guide/多版本_15.png)

暂停版本控制后，新上传版本将会覆盖上为传唯一的null版本。
![](/images/guide/多版本_16.png)

## 功能介绍
### 开启版本控制下的文件操作
#### 上传文件
bucket打开版本控制后，每次会对新上传Object将会生成一个的版本ID，这个版本ID在相同Object内唯一。
```
说明：PutFile, PostFile, MultipartUpload, Copy等操作都会对Object生成新的版本。
```
例如，我们对名为demo.txt且在US3上不存在的Object，连续上传三次，US3将会对三次上传的数据都生成一个不重复的版本ID，分别为000001、000002和000003。
![](/images/guide/多版本_1.png)

如果打开版本控制前，原demo1.txt已经存在，那么打开版本控制后此版本将自动变成null版本。此时上传文件，此null版本将变成历史版本。

![](/images/guide/多版本_2.png)

#### 删除文件

开启版本控制后，用户不指定版本ID的删除行为，将不会真实删除文件，而是生成一条删除标记（Delete Marker）。如果用户想要真实删除Object，则可以在删除文件时指定想要删除的版本ID来永久删除该版本，或者配置生命周期进行删除。\
用户可以进行以下两种删除行为：
- 不携带版本ID：不传入版本ID时，此时将会在后端插入一条删除标记，不会对文件进行删除操作。
![](/images/guide/多版本_3.png)
- 携带版本ID：将删除指定版本（文件和删除标记），不存在返回404 not found；
![](/images/guide/多版本_4.png)

需要注意的是，如果Object的当前版本已经是删除标记，或者该Object不存在，将直接返回404，减少重复无用的删除标记。
![](/images/guide/多版本_5.png)

#### 下载文件
开启Bucket版本控制时，用户可以下载某个Object的当前版本，或者指定版本。当用户通过GET请求下载某个Object（demo.txt），如果未指定版本ID，默认返回该Object的当前版本。如果该Object的当前版本为删除标记，则返回404 not found。
![](/images/guide/多版本_6.png)

下载文件时，也可以指定想要下载的版本ID，若存在则返回指定版本ID的文件，不存在则返回404 not found。
![](/images/guide/多版本_7.png)

#### 列表文件
对于已经开启过版本控制的bucket，用户可以调用ListObjectVersions来获取所有key的所有版本，包括删除标记（Delete Marker）。也可以通过ListObjects来获取每个Object的最新版本，若最新版本为删除标记，则此Object将不会返回。\
如下图所示，用户调用ListObjectVersions时，返回了该Bucket的所有版本，包括删除标记（Delete Marker）。用户调用ListObjects时，因为demo2.txt的当前版本为删除标记，因此结果只返回了demo1.txt的当前版本。
![](/images/guide/多版本_8.png)

### 暂停版本控制下的文件操作

暂停版本控制时，下载文件和列表文件的行为与开启版本控制时没有区别，这里不作重复介绍。

#### 上传文件 
暂停bucket的版本控制后，对同一个Object的上传行为，将不再会形成历史版本的累积，而是转而覆盖上传一个最新的指定版本（null）。此时，每次新上传Object，都将生成唯一的版本ID null。若该Object不存在旧的null版本，则直接生成版本ID为null的当前版本；若该Object存在旧null版本（文件或删除标记），则旧的null版本将会被覆盖，同时生成版本ID为null的当前版本。\
如下图所示，当没有旧的null时，US3直接生成版本ID为null的当前版本。
![](/images/guide/多版本_9.png)

当存在旧的null（文件或删除标记）版本时，旧的数据将会被新上传的版本覆盖。
![](/images/guide/多版本_10.png)

#### 删除文件
暂停bucket的版本控制后，对Object的删除行为，同样分为携带版本号和未携带版本号两种行为。与开启状态下不同的是，此时未携带版本ID的删除，将会生成版本ID为null的删除标记。同样的，如果此时存在旧的null版本，旧的null版本将会被此null版本的删除标记覆盖。
![](/images/guide/多版本_11.png)

与版本开启状态下相同，如果Object的当前版本已经是删除标记，或者该Object不存在，将直接返回404。